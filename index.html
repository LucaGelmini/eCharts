<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@latest/dist/echarts.min.js"></script>
    <title>Echart flechitas</title>
  </head>
  <body>
    <div id="main" style="width: 100vw; height: 100vh"></div>
  </body>
</html>

<script>
  const myChart = echarts.init(document.getElementById("main"));

  /*const data = [
    { name: "ProductA", value: [Math.random() * 100, Math.random() * 100] },
    { name: "ProductB", value: [Math.random() * 100, Math.random() * 100] },
    { name: "ProductC", value: [Math.random() * 100, Math.random() * 100] },
    { name: "ProductD", value: [Math.random() * 100, Math.random() * 100] },
    { name: "ProductE", value: [Math.random() * 100, Math.random() * 100] },
    { name: "ProductF", value: [Math.random() * 100, Math.random() * 100] },
  ];*/

  fetch("/data_secciones.json")
    .then((res) => res.json())
    .then((data) => {
      data = data
        .sort((prev, curr) => {
          prev = prev.expo2023 > prev.expo2024 ? prev.expo2023 : prev.expo2024;
          curr = curr.expo2023 > curr.expo2024 ? curr.expo2023 : curr.expo2024;
          return prev - curr;
        })
        .map((row) => {
          splited = row.secciones.split("-");
          row.xAxisName = splited.length > 1 ? splited[0] : "Resto";
          return row;
        });

      const options = {
        title: {
          text: "Exportaciones de 2023 y 2024 por secciones",
          left: "center",
        },
        yAxis: {
          type: "category",
          data: data.map((row) => row.xAxisName),
          axisLabel: {
            interval: 0,
          },
        },
        xAxis: {
          type: "value",
        },
        series: data
          .map((row, index) => {
            const prevVal = row.expo2023;
            const currVal = row.expo2024;
            const diff = currVal - prevVal;
            const start = diff >= 0 ? prevVal : currVal;
            const end = start + Math.abs(diff);
            const color = diff >= 0 ? "green" : "red";
            const rotation = diff < 0 ? 90 : -90;

            return [
              {
                name: row.secciones,
                type: "scatter",

                data: [
                  [start, index],
                  [end, index],
                ],
              },
              {
                name: "Arrow" + row.secciones,
                type: "line",

                data: [
                  [start, index],
                  [end, index],
                ],
                lineStyle: {
                  color: color,
                },
                symbolSize: 15,
                symbol: (params, api) => {
                  if (diff < 0) {
                    return api.dataIndex === 0 ? "arrow" : "none";
                  }
                  if (diff >= 0) {
                    return api.dataIndex === 1 ? "arrow" : "none";
                  }
                },
                symbolRotate: rotation,
                itemStyle: {
                  color: color,
                },
              },
            ];
          })
          .flat(),
        tooltip: {
          trigger: "axis",
          axisPointer: {
            type: "cross",
          },
          formatter: (params) => {
            let prevVal = undefined;
            let currVal = undefined;
            params.forEach((item, index) => {
              if (item.componentSubType === "scatter") {
                if (index == 0) {
                  currVal = item.data[0];
                }
                if (index == 1) {
                  prevVal = item.data[0];
                }
              }
            });
            return `<h3>${params[0].seriesName}</h3><p>2023: ${prevVal}MUSD</p><p>2024: ${currVal}MUSD</p>`;
          },
        },
      };

      myChart.setOption(options);
    });
</script>
