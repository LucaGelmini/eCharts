<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@latest/dist/echarts.min.js"></script>
    <title>Echart flechitas</title>
  </head>
  <body>
    <div id="main" style="width: 100vw; height: 100vh"></div>
  </body>
</html>

<script>
  const myChart = echarts.init(document.getElementById("main"));  const fetchAndSortData = async () => {
    const res = await fetch("/data_secciones.json");
    let data = await res.json();
    data = data
      .sort((prev, curr) => {
        prev = prev.expo2023 > prev.expo2024 ? prev.expo2023 : prev.expo2024;
        curr = curr.expo2023 > curr.expo2024 ? curr.expo2023 : curr.expo2024;
        return prev - curr;
      })
      .map((row, index) => {
        splited = row.secciones.split("-");
        row.xAxisName = splited.length > 1 ? splited[0] : "Resto";
        return {
          secciones: row.secciones,
          expo2024: row.expo2024,
          viaExpo: row.viaExpo,
          impo2024: row.impo2024,
          viaImpo: row.viaImpo,
          saldo: row.saldo,
          expo2023: row.expo2023,
          impo2023: row.impo2023,
          xAxisName: row.xAxisName,
          index: index,
        };
      });

    return data;
  };

  fetchAndSortData().then((data) => {
    console.log(
      data.map((item) => {
        return {
          type: "line",
          data: [
            [item.expo2023, item.index],
            [item.expo2024, item.index],
          ],
        };
      })
    );
    const options = {
      title: {
        text: "Exportaciones de 2023 y 2024 por secciones",
        left: "center",
      },
      dataset: {
        source: data,
      },
      xAxis: { type: "value" },
      yAxis: {
        type: "category",
        axisLabel: {
          formatter: (params, index) => {
            return data[index].xAxisName;
          },
          interval: 0,
        },
      },
      series: [
        {
          type: "scatter",
          encode: {
            x: "expo2023",
            y: "index",
          },
        },
        {
          type: "scatter",
          encode: {
            x: "expo2024",
            y: "index",
          },
        },
        ...data.map((item) => {
          const prevVal = item.expo2023;
          const currVal = item.expo2024;
          const diff = currVal - prevVal;
          const start = diff >= 0 ? prevVal : currVal;
          const end = start + Math.abs(diff);
          const color = diff >= 0 ? positiveColor : negativeColor;
          const rotation = diff < 0 ? 90 : -90;
          return {
            type: "line",
            data: [
              [item.expo2023, item.index],
              [item.expo2024, item.index],
            ],
            lineStyle: {
              color: color,
            },
            symbolSize: 15,
            symbol: (params, api) => {
              if (diff < 0) {
                return api.dataIndex === 0 ? "none" : "arrow";
              }
              if (diff >= 0) {
                return api.dataIndex === 0 ? "none" : "arrow";
              }
            },
            symbolRotate: rotation,
            itemStyle: {
              color: color,
            },
          };
        }),
      ],
      tooltip: {
        trigger: "axis",
        formatter: function (params) {
          return `<h3>${params[0].data.secciones}</h3>
            <p>Expo 2024: ${params[0].data.expo2024}</p>
            <p>Expo 2023: ${params[0].data.expo2023}</p>
            <p>V.i.a Expo: ${params[0].data.viaExpo}</p>
            <p>Saldo: ${params[0].data.saldo}</p>`;
        },
      },
    };
    myChart.setOption(options);
  });
</script>
